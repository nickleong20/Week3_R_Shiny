# Install required packages if not already installed
if (!require("shiny")) install.packages("shiny")
if (!require("OpenSpecy")) install.packages("OpenSpecy")
if (!require("dplyr")) install.packages("dplyr")
if (!require("DT")) install.packages("DT")
if (!require("progress")) install.packages("progress")

library(shiny)
library(OpenSpecy)
library(dplyr)
library(DT)
library(progress)

# Fetch FTIR library
get_lib()

# Load FTIR library into global environment
spec_lib <- load_lib()

# Define UI
ui <- fluidPage(
  titlePanel("OpenSpecy Spectral Analysis"),
  sidebarLayout(
    sidebarPanel(
      fileInput("file", "Upload a file:",
                accept = c(
                  "text/csv",
                  "text/comma-separated-values,text/plain",
                  ".csv",
                  ".asp",
                  ".jdx",
                  ".spc",
                  ".spa",
                  ".0"
                )
      ),
      tags$small("Accepted file types: CSV, ASP, JDX, SPC, SPA, 0"),
      downloadButton("download_example", "Download Example Dataset")  # Add the Download button
    ),
    mainPanel(
      tabsetPanel(
        tabPanel("Results Table", DT::dataTableOutput("table")),
        tabPanel("Help", 
                 p("Welcome to the OpenSpecy Spectral Analysis App!"),
                 p("Common Issues:"),
                 ol(
                   li("Ensure you upload a file with one of the supported extensions: CSV, ASP, JDX, SPC, SPA, 0."),
                   li("For intensity smoothing and background correction, input valid values within the specified ranges (1 to 7 for smoothing, 1 to 20 for background)."),
                   li("If the results table is empty, the uploaded spectrum may not match any spectra in the FTIR library."),
                   li("Check your internet connection and ensure all required packages are installed and loaded correctly."),
                   li("Large datasets or a high number of combinations can increase processing time."),
                   li("Refer to the app's documentation and error messages for additional troubleshooting."),
                   li("In case of R session crashes, consider using smaller datasets or optimizing system resources.")
                 )
        )
      )
    )
  )
)


# Define server logic
server <- function(input, output) {
  data <- reactiveVal(NULL)
  
  observeEvent(input$file, {
    progress <- Progress$new(session = shiny::getDefaultReactiveDomain(), min = 0, max = 100)
    progress$set(message = 'Processing data...')
    
    spec_data <- reactive({
      req(input$file)
      file_extension <- tools::file_ext(input$file$name)
      if (file_extension %in% c("csv", "CSV")) {
        read.csv(input$file$datapath, header = TRUE, stringsAsFactors = FALSE)
      } else if (file_extension %in% c("asp", "ASP")) {
        OpenSpecy::read_asp(input$file$datapath)
      } else if (file_extension %in% c("jdx", "JDX")) {
        OpenSpecy::read_jdx(input$file$datapath)
      } else if (file_extension %in% c("spc", "SPC")) {
        OpenSpecy::read_spc(input$file$datapath)
      } else if (file_extension %in% c("spa", "SPA")) {
        OpenSpecy::read_spa(input$file$datapath)
      } else if (file_extension %in% c("0")) {
        OpenSpecy::read_0(input$file$datapath)
      } else {
        # File type not supported
        stop(paste0("Unsupported file type: ", file_extension))
      }
    })()

# Define a reactive function to create testdata.csv
  create_testdata <- function() {
    # Sample data for testdata.csv
    testdata <- data.frame(
      wavenumber = c(301.04
304.632
308.221
311.81
315.398
318.983
322.566
326.15
329.732
333.311
336.889
340.467
344.042
347.618
351.19
354.76
358.332
361.9
365.466
369.031
372.597
376.16
379.721
383.28
386.839
390.396
393.951
397.505
401.058
404.61
408.16
411.708
415.256
418.801
422.346
425.887
429.429
432.97
436.507
440.044
443.581
447.116
450.647
454.18
457.708
461.238
464.764
468.291
471.815
475.339
478.859
482.379
485.899
489.416
492.931
496.447
499.96
503.471
506.981
510.489
513.999
517.503
521.009
524.51
528.014
531.513
535.014
538.51
542.008
545.502
548.997
552.488
555.979
559.469
562.955
566.442
569.928
573.411
576.894
580.376
583.854
587.331
590.811
594.286
597.759
601.231
604.705
608.174
611.642
615.109
618.574
622.038
625.503
628.966
632.426
635.884
639.342
642.798
646.252
649.706
653.158
656.608
660.058
663.506
666.953
670.398
673.842
677.285
680.727
684.165
687.602
691.04
694.476
697.911
701.345
704.775
708.204
711.634
715.063
718.49
721.912
725.336
728.76
732.18
735.599
739.018
742.434
745.849
749.265
752.675
756.088
759.498
762.906
766.313
769.719
773.124
776.527
779.929
783.33
786.729
790.127
793.524
796.919
800.312
803.705
807.097
810.485
813.874
817.262
820.647
824.032
827.416
830.797
834.179
837.557
840.936
844.312
847.688
851.061
854.433
857.806
861.175
864.543
867.91
871.278
874.642
878.005
881.367
884.728
888.087
891.445
894.802
898.157
901.511
904.864
908.216
911.567
914.914
918.262
921.609
924.954
928.296
931.639
934.981
938.32
941.659
944.995
948.332
951.665
954.999
958.33
961.66
964.991
968.318
971.644
974.971
978.295
981.617
984.94
988.258
991.578
994.896
998.212
1001.53
1004.84
1008.15
1011.46
1014.77
1018.08
1021.39
1024.7
1028
1031.3
1034.61
1037.91
1041.21
1044.51
1047.8
1051.1
1054.39
1057.68
1060.98
1064.27
1067.56
1070.84
1074.13
1077.42
1080.7
1083.98
1087.27
1090.55
1093.83
1097.1
1100.38
1103.65
1106.93
1110.2
1113.47
1116.74
1120.01
1123.28
1126.55
1129.81
1133.08
1136.34
1139.6
1142.86
1146.12
1149.37
1152.63
1155.89
1159.14
1162.39
1165.64
1168.89
1172.14
1175.39
1178.64
1181.88
1185.12
1188.37
1191.61
1194.85
1198.09
1201.32
1204.56
1207.79
1211.03
1214.26
1217.49
1220.72
1223.95
1227.18
1230.4
1233.63
1236.85
1240.07
1243.3
1246.52
1249.74
1252.95
1256.17
1259.38
1262.6
1265.81
1269.02
1272.23
1275.44
1278.65
1281.85
1285.06
1288.26
1291.46
1294.67
1297.87
1301.07
1304.26
1307.46
1310.66
1313.85
1317.04
1320.23
1323.42
1326.61
1329.8
1332.99
1336.17
1339.36
1342.54
1345.72
1348.9
1352.08
1355.26
1358.44
1361.61
1364.79
1367.96
1371.13
1374.3
1377.47
1380.64
1383.81
1386.97
1390.14
1393.3
1396.47
1399.63
1402.79
1405.95
1409.1
1412.26
1415.41
1418.57
1421.72
1424.87
1428.02
1431.17
1434.32
1437.47
1440.61
1443.76
1446.9
1450.04
1453.18
1456.32
1459.46
1462.59
1465.73
1468.87
1472
1475.13
1478.26
1481.4
1484.52
1487.65
1490.78
1493.9
1497.03
1500.15
1503.27
1506.39
1509.51
1512.63
1515.74
1518.86
1521.97
1525.09
1528.2
1531.31
1534.42
1537.53
1540.64
1543.74
1546.85
1549.95
1553.05
1556.16
1559.26
1562.36
1565.45
1568.55
1571.65
1574.74
1577.83
1580.92
1584.02
1587.11
1590.19
1593.28
1596.37
1599.45
1602.54
1605.62
1608.7
1611.78
1614.86
1617.94
1621.02
1624.09
1627.17
1630.24
1633.31
1636.38
1639.45
1642.52
1645.59
1648.65
1651.72
1654.78
1657.85
1660.91
1663.97
1667.03
1670.09
1673.15
1676.2
1679.26
1682.31
1685.36
1688.41
1691.46
1694.51
1697.56
1700.61
1703.65
1706.7
1709.74
1712.78
1715.83
1718.86
1721.9
1724.94
1727.98
1731.01
1734.05
1737.08
1740.11
1743.14
1746.17
1749.2
1752.23
1755.25
1758.28
1761.3
1764.33
1767.35
1770.37
1773.39
1776.41
1779.42
1782.44
1785.46
1788.47
1791.48
1794.49
1797.5
1800.51
1803.52
1806.53
1809.53
1812.54
1815.54
1818.54
1821.54
1824.55
1827.55
1830.54
1833.54
1836.54
1839.53
1842.52
1845.51
1848.51
1851.5
1854.49
1857.48
1860.46
1863.45
1866.43
1869.41
1872.4
1875.38
1878.36
1881.34
1884.32
1887.29
1890.27
1893.24
1896.22
1899.19
1902.16
1905.13
1908.1
1911.07
1914.03
1917
1919.96
1922.93
1925.89
1928.85
1931.81
1934.77
1937.43
1940.4
1943.36
1946.33
1949.3
1952.27
1955.23
1958.19
1961.16
1964.12
1967.08
1970.04
1972.99
1975.95
1978.91
1981.86
1984.82
1987.77
1990.72
1993.67
1996.62
1999.57
2002.52
2005.46
2008.41
2011.35
2014.29
2017.24
2020.18
2023.12
2026.05
2028.99
2031.93
2034.87
2037.8
2040.73
2043.66
2046.6
2049.52
2052.45
2055.38
2058.31
2061.23
2064.16
2067.08
2070
2072.93
2075.85
2078.77
2081.68
2084.6
2087.52
2090.43
2093.34
2096.26
2099.17
2102.08
2104.99
2107.9
2110.81
2113.71
2116.62
2119.52
2122.43
2125.33
2128.23
2131.13
2134.03
2136.93
2139.82
2142.72
2145.61
2148.51
2151.4
2154.29
2157.18
2160.07
2162.96
2165.85
2168.73
2171.62
2174.5
2177.39
2180.27
2183.15
2186.03
2188.91
2191.79
2194.67
2197.54
2200.42
2203.29
2206.16
2209.03
2211.9
2214.77
2217.64
2220.51
2223.38
2226.24
2229.11
2231.97
2234.83
2237.69
2240.55
2243.41
2246.27
2249.13
2251.98
2254.84
2257.69
2260.54
2263.39
2266.25
2269.1
2271.94
2274.79
2277.64
2280.49
2283.33
2286.17
2289.02
2291.86
2294.7
2297.54
2300.38
2303.21
2306.05
2308.89
2311.72
2314.55
2317.39
2320.22
2323.05
2325.88
2328.7
2331.53
2334.36
2337.18
2340.01
2342.83
2345.65
2348.47
2351.29
2354.11
2356.93
2359.75
2362.56
2365.38
2368.19
2371
2373.82
2376.63
2379.44
2382.25
2385.05
2387.86
2390.67
2393.47
2396.28
2399.08
2401.88
2404.68
2407.48
2410.28
2413.08
2415.87
2418.67
2421.46
2424.26
2427.05
2429.84
2432.63
2435.42
2438.21
2441
2443.79
2446.57
2449.36
2452.14
2454.92
2457.7
2460.48
2463.26
2466.04
2468.82
2471.6
2474.37
2477.15
2479.92
2482.69
2485.47
2488.24
2491.01
2493.77
2496.54
2499.31
2502.07
2504.84
2507.6
2510.37
2513.13
2515.89
2518.65
2521.41
2524.16
2526.92
2529.68
2532.43
2535.19
2537.94
2540.69
2543.44
2546.19
2548.94
2551.69
2554.44
2557.18
2559.93
2562.67
2565.42
2568.16
2570.9
2573.64
2576.38
2579.11
2581.85
2584.59
2587.32
2590.06
2592.79
2595.52
2598.25
2600.98
2603.72
2606.44
2609.17
2611.9
2614.62
2617.35
2620.07
2622.79
2625.51
2628.23
2630.95
2633.67
2636.39
2639.11
2641.82
2644.54
2647.25
2649.96
2652.68
2655.39
2658.1
2660.81
2663.51
2666.22
2668.93
2671.63
2674.34
2677.04
2679.74
2682.44
2685.14
2687.84
2690.54
2693.24
2695.94
2698.63
2701.33
2704.02
2706.71
2709.41
2712.1
2714.79
2717.47
2720.16
2722.85
2725.53
2728.22
2730.9
2733.59
2736.27
2738.95
2741.63
2744.31
2746.99
2749.67
2752.34
2755.02
2757.69
2760.37
2763.04
2765.71
2768.38
2771.05
2773.72
2776.39
2779.06
2781.72
2784.39
2787.05
2789.71
2792.38
2795.04
2797.7
2800.36
2803.02
2805.68
2808.33
2810.99
2813.64
2816.3
2818.95
2821.6
2824.25
2826.9
2829.55
2832.2
2834.85
2837.49
2840.14
2842.78
2845.43
2848.07
2850.71
2853.35
2855.99
2858.63
2861.27
2863.91
2866.54
2869.18
2871.81
2874.45
2877.08
2879.71
2882.34
2884.97
2887.6
2890.23
2892.86
2895.48
2898.11
2900.73
2903.35
2905.97
2908.6
2911.22
2913.84
2916.46
2919.07
2921.69
2924.31
2926.92
2929.54
2932.15
2934.76
2937.37
2939.98
2942.59
2945.2
2947.81
2950.42
2953.02
2955.63
2958.23
2960.83
2963.44
2966.04
2968.64
2971.24
2973.83
2976.43
2979.03
2981.63
2984.22
2986.81
2989.41
2992
2994.59
2997.18
2999.77
3002.36
3004.95
3007.53
3010.12
3012.7
3015.29
3017.87
3020.45
3023.04
3025.62
3028.2
3030.77
3033.35
3035.93
3038.5
3041.08
3043.65
3046.23
3048.8
3051.37
3053.94
3056.51
3059.08
3061.65
3064.21
3066.78
3069.35
3071.91
3074.47
3077.04
3079.6
3082.16
3084.72
3087.28
3089.83
3092.39
3094.95
3097.5
3100.06
3102.61
3105.16
3107.72
3110.27
3112.82
3115.37
3117.91
3120.46
3123.01
3125.56
3128.1
3130.64
3133.19
3135.73
3138.27
3140.81
3143.35
3145.89
3148.43
3150.96
3153.5
3156.03
3158.57
3161.1
3163.64
3166.17
3168.7
3171.23
3173.76
3175.3
3177.84
3180.38
3182.91
3185.45
3187.99
3190.52
3193.06
3195.59
3198.12),
      intensity = c(26
50
48
45
46
42
45
44
48
46
48
44
49
52
48
53
52
46
41
50
62
57
52
45
55
42
52
44
62
57
50
59
48
47
59
58
58
74
69
78
67
73
59
72
65
53
65
63
61
56
47
52
53
58
58
43
54
55
50
47
55
58
50
47
44
55
56
58
54
52
45
64
62
62
57
55
49
65
62
53
55
59
73
63
63
67
77
74
74
79
66
66
67
60
59
48
44
57
61
59
48
59
59
43
50
49
61
58
64
74
49
64
55
55
62
52
62
55
65
54
52
66
54
54
54
60
55
56
53
61
63
53
50
62
62
70
63
61
55
56
70
62
66
60
56
67
57
64
56
51
56
59
61
53
68
64
51
60
62
62
76
65
53
68
53
51
57
53
63
60
74
59
73
51
74
65
64
59
70
61
42
71
66
52
70
67
58
65
64
66
75
59
60
64
63
68
61
53
60
67
57
74
59
64
69
76
59
65
65
75
86
78
70
76
84
78
69
66
83
90
96
128
143
101
81
76
72
85
79
83
67
79
64
80
72
74
70
81
79
82
95
119
148
94
80
71
82
76
76
76
82
73
66
80
79
101
71
83
75
66
72
76
68
88
81
66
67
68
81
67
69
78
68
64
81
83
78
74
67
64
82
72
79
65
84
76
87
75
76
87
82
101
128
200
143
105
101
87
77
88
76
79
95
76
67
82
82
70
82
72
88
66
68
71
84
74
100
83
69
91
81
77
84
75
86
71
92
94
77
93
93
110
112
103
106
110
125
123
169
178
166
129
117
116
127
136
143
127
114
101
85
93
98
87
97
94
95
85
94
93
85
93
74
75
81
105
95
105
105
103
86
85
102
75
72
89
96
92
86
85
90
100
91
88
98
83
84
93
97
71
73
88
78
84
90
97
89
88
86
89
89
89
89
96
98
103
94
91
98
108
80
100
88
101
104
91
96
98
102
96
100
82
87
107
94
105
96
105
106
110
96
88
98
94
99
85
99
93
91
96
94
103
100
106
86
105
100
90
102
100
100
121
121
107
97
94
116
105
100
98
102
107
110
100
107
101
114
106
109
115
116
108
114
112
110
112
108
107
109
109
105
102
107
111
109
108
112
108
102
105
110
108
95
107
99
106
110
115
107
100
108
107
107
113
93
113
124
119
109
101
109
120
112
108
111
116
97
106
114
116
125
109
103
114
122
122
106
124
105
120
105
118
114
105
118
115
112
116
112
132
116
106
115
113
108
136
131
123
108
120
131
121
126
124
137
130
129
119
126
136
135
135
130
130
124
126
122
131
120
140
120
138
128
127
131
146
133
141
124
123
137
131
127
128
123
135
123
121
128
141
136
136
119
114
122
127
135
138
126
125
118
121
129
133
137
131
118
142
103
113
123
110
135
128
133
121
131
118
115
122
124
114
120
136
129
123
119
119
118
114
116
116
120
108
113
114
129
116
110
109
118
103
121
120
108
108
119
130
104
107
95
110
96
117
109
111
111
112
113
112
101
110
107
96
99
105
101
99
103
97
96
108
107
103
103
112
103
115
108
107
102
108
103
102
98
102
98
105
107
95
103
112
112
105
99
105
112
99
99
106
101
97
102
99
99
102
95
109
96
100
99
103
117
100
106
110
96
97
105
98
100
90
94
107
101
92
96
106
105
76
93
104
101
104
95
95
93
81
104
96
101
98
91
103
85
100
87
87
98
100
100
95
114
96
105
106
81
96
104
103
89
108
92
89
96
81
91
100
102
103
99
119
104
97
99
128
116
126
123
130
121
132
115
111
109
102
96
108
104
82
100
107
97
81
100
101
98
98
100
102
97
95
90
93
102
95
103
106
102
99
101
117
101
104
114
112
119
106
116
131
132
148
169
200
303
378
452
489
465
431
388
356
333
318
305
308
305
335
407
576
816
664
494
393
352
318
322
321
308
279
254
257
238
222
214
219
199
207
212
226
206
181
186
162
148
107
119
110
113
101
109
114
105
107
94
91
97
101
87
108
95
103
95
94
96
89
89
105
94
79
85
99
93
84
77
95
92
73
89
98
72
80
81
98
87
81
86
92
85
86
92
86
82
87
86
93
87
88
87
81
82
90
76
90
83
80
75
82
83
76
74
84
83
73
74
77
77
77
81
80
77
75
68
69
77
77
73
74
81
75
68
73
75
76
77
75
77
71
77
71
71
75
75
67)
    )
    return(testdata)
  }
  
  # Download handler to generate and download testdata.csv
  output$download_example <- downloadHandler(
    filename = function() {
      "testdata.csv"
    },
    content = function(file) {
      # Call the create_testdata function to get the data
      testdata <- create_testdata()
      # Write data to CSV file
      write.csv(testdata, file, row.names = FALSE)
    }
  )
    
    # Adjust spectral intensity
    adj_data <- spec_data %>% adj_intens()
    progress$inc(10, detail = "Adjusted spectral intensity")
    
    # Test if Raman or FTIR 
    testraman <- match_spec(spec_data, library = spec_lib, which = "raman")
    testftir <- match_spec(spec_data, library = spec_lib, which = "ftir")
    
    testraman <- head(testraman, 1)
    testftir <- head(testftir, 1)
    
    if (!is.null(testraman) && !is.null(testftir)) {
      if (testraman$rsq > testftir$rsq) {
        spectrum_type <- "Raman"
      } else {
        spectrum_type <- "FTIR"
      }
    } else if (!is.null(testraman)) {
      spectrum_type <- "Raman"
    } else if (!is.null(testftir)) {
      spectrum_type <- "FTIR"
    } else {
      spectrum_type <- "Unknown"
    }
    progress$inc(10, detail = "Identified spectrum type")
    
    # Create a vector of smoothing factors
    smoothing_factors <- 1:7
    
    # Create a vector of subtr_bg values
    subtr_bg_values <- 1:20
    
    # Initialize an empty data frame to store the results
    results <- data.frame(
      smooth_intens = integer(),
      subtr_bg = integer(),
      top_result = character(),
      type = character(),
      stringsAsFactors = FALSE
    )
    
    for (factor in smoothing_factors) {
      for (subtr_bg_value in subtr_bg_values) {
        # Smooth and background-correct spectrum with current smoothing factor and subtr_bg value
        proc_data <- adj_data %>% smooth_intens(factor) %>% subtr_bg(subtr_bg_value)
        
        if (spectrum_type == "Raman") {
          # Match spectrum with library and retrieve meta data for Raman
          match_result_raman <- match_spec(proc_data, library = spec_lib, which = "raman")
          
          # Retrieve the top displayed result for Raman
          top_raman <- head(match_result_raman, 1)
          
          # Create data frames for each smoothing factor and subtr_bg value
          results_raman <- data.frame(
            smooth_intens = factor,
            subtr_bg = subtr_bg_value,
            top_result = top_raman,
            type = "Raman",
            stringsAsFactors = FALSE
          )
          
          # Append the data frames to the results data frame
          results <- rbind(results, results_raman)
        } else if (spectrum_type == "FTIR") {
          # Match spectrum with library and retrieve meta data for FTIR
          match_result_ftir <- match_spec(proc_data, library = spec_lib, which = "ftir")
          
          # Retrieve the top displayed result for FTIR
          top_ftir <- head(match_result_ftir, 1)
          
          # Create data frames for each smoothing factor and subtr_bg value
          results_ftir <- data.frame(
            smooth_intens = factor,
            subtr_bg = subtr_bg_value,
            top_result = top_ftir,
            type = "FTIR",
            stringsAsFactors = FALSE
          )
          
          # Append the data frames to the results data frame
          results <- rbind(results, results_ftir)
        }
      }
    }
    progress$inc(70, detail = "Processed all combinations")
    progress$close()
    
    # Update the results table
    output$table <- DT::renderDataTable({
      DT::datatable(results, 
                    colnames = c("Smoothing Intensity", "Baseline Correction", "Sample Name", 
                                 "Spectrum Identity", "R-Value", "Organization", "Spectrum Type"))
    })
  })
}

# Run the application
shinyApp(ui = ui, server = server)
